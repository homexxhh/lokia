#-*— coding:UTF-8 -*-
#/usr/bin/env python
"""
module descript
"""
import hashlib
# import xml.etree.ElementTree as ET

# from django.utils.encoding import smart_str
from django.http import HttpResponse
from django.views.generic import TemplateView
from django.views.decorators import csrf
from lib.utils import parase_request, parase_msg_xml
from lib.response import TextResponse, BaseResponse
from django.shortcuts import render_to_response
import time
import menu
import token


class IndexView(TemplateView):
    template_name = "test.xml"

    def get(self, request, *args, **kwargs):
        command = request.GET.get('com', None)
        if command == "menu":
            menu.create_menu()
            return HttpResponse("succeed")
        else:
            return super(IndexView, self).get(request, *args, **kwargs)

    def get_context_data(self, **kwargs):
        context = {'ToUserName': '我去', 'FromUserName': '尼玛', 'CreateTime': '草鸡空碟',
                   'Content': '尼，肯跌啊'}
        return context


@csrf.csrf_exempt
def check_signature(request):
    signature = request.GET.get("signature", None)
    timestamp = request.GET.get("timestamp", None)
    nonce = request.GET.get("nonce", None)
    echo_str = request.GET.get("echostr", None)
    tok = token.TOKEN
    tmp_list = [tok, timestamp, nonce]
    tmp_list.sort()
    tmp_str = "%s%s%s" % tuple(tmp_list)
    tmp_str = hashlib.sha1(tmp_str).hexdigest()
    if tmp_str == signature:
        response = HttpResponse(echo_str, content_type="text/plain")
        return response
    else:
        return HttpResponse(None, content_type='text/plain')


#要注意的是不能把parase_request放在csrf.csrf_exempt前面
#因为csrf.csrf_exempt需要访问request数据，建议把parase_request
# 放在最后面
@csrf.csrf_exempt
@token.ensure_access_token_effective
@parase_request
def response_msg(msg):
    # resp = TextResponse(msg)
    context = {'Content': '我靠'}
    response_msg = {'ToUserName': msg['FromUserName'],
                    'FromUserName': msg['ToUserName'],
                    'CreateTime': time.time()}
    response_msg.update(context)
    return render_to_response("test.xml", response_msg, mimetype="application/xml")

@csrf.csrf_exempt
@token.ensure_access_token_effective
@parase_request
def other_index(request):
    # resp = TextResponse(msg)
    context = {'Content': '我靠'}
    response_msg = {'ToUserName': 'FromUserName',
                    'FromUserName': 'ToUserName',
                    'CreateTime': time.time()}
    response_msg.update(context)
    return render_to_response("test.xml", response_msg, mimetype="application/xml")


@csrf.csrf_exempt
@token.ensure_access_token_effective
@parase_request
def about(msg):
    resp = BaseResponse(msg)
    resp.template_name = '/about.xml'
    resp = resp.get_response()
    return resp


@csrf.csrf_exempt
@token.ensure_access_token_effective
@parase_request
def contact(msg):
    resp = BaseResponse(msg)
    resp.template_name = '/contact.xml'
    resp = resp.get_response()
    return resp


def getReply(msg, replyContent):
    import time

    extTpl = "<xml><ToUserName><![CDATA[%s]]></ToUserName><FromUserName><![CDATA[%s]]></FromUserName><CreateTime>%s</CreateTime><MsgType><![CDATA[%s]]></MsgType><Content><![CDATA[%s]]></Content><FuncFlag>0</FuncFlag></xml>";
    extTpl = extTpl % (msg['FromUserName'], msg['ToUserName'], str(int(time.time())), 'text', replyContent)
    return HttpResponse(extTpl, content_type="application/xml")





