#-*â€” coding:UTF-8 -*-
#/usr/bin/env python
import json
import urllib
from lib.utils import download, post, ensure_effective
import token
import time

"""
module descript
"""
TICKET = None
TICKET_EFFECTIVE_TIME = 0
GET_QR_CODE_TICKET_URL = "https://api.weixin.qq.com/cgi-bin/qrcode/create"
GET_QR_CODE_TICKET_JSON = {"action_name": "QR_LIMIT_SCENE", "action_info": {"scene": {"scene_id": 123}}}
GET_QR_CODE_URL = "https://mp.weixin.qq.com/cgi-bin/showqrcode"


@token.ensure_access_token_effective
def get_ticket():
    global TICKET
    global TICKET_EFFECTIVE_TIME
    url = GET_QR_CODE_TICKET_URL + "?" + \
          urllib.urlencode({"access_token": token.ACCESS_TOKEN})
    resp_data = post(url, json.dumps(GET_QR_CODE_TICKET_JSON))
    ticket_json = json.loads(resp_data)
    TICKET = ticket_json["ticket"]
    TICKET_EFFECTIVE_TIME = resp_data["expire_seconds"] + time.time()
    return TICKET, TICKET_EFFECTIVE_TIME


def ensure_ticket_effective(f):
    return ensure_effective(f, get_ticket, TICKET_EFFECTIVE_TIME)


@ensure_ticket_effective
def get_qrcode():
    url = GET_QR_CODE_URL + "?" + urllib.urlencode({"ticket": TICKET})
    qr_data = download(url)
    return qr_data


